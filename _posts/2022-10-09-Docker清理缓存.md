---
layout: post
title: Docker æ¸…ç†ç¼“å­˜
date: 2022-10-09
tags: æŠ€å·§
---

# Docker æ¸…ç†ç¼“å­˜ã€æ—¥å¿—ã€æ— ç”¨çš„é•œåƒ

[ç›®å½•]

[TOC]

------------
## æ–¹æ³•ä¸€
##### ç¬¬ä¸€æ­¥ï¼šæŸ¥çœ‹
    # æŸ¥çœ‹dockerå„ç±»å‹æ–‡ä»¶å ç”¨æƒ…å†µ
    docker system df

##### ç¬¬äºŒæ­¥ï¼šç®€å•åˆ é™¤æœªä½¿ç”¨å®¹å™¨
    # ç®€å•åˆ é™¤æœªä½¿ç”¨å®¹å™¨
    docker system prune


##### ç¬¬ä¸‰æ­¥ï¼šåˆ é™¤æ‰€æœ‰æœªä½¿ç”¨å®¹å™¨
    # åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨å®¹å™¨
    docker system prune -a

##### å…¶ä»–åˆ é™¤å‚è€ƒå¦‚ä¸‹ï¼š
[docker æ¸…ç†ç¼“å­˜ã€æ—¥å¿—ã€æ— ç”¨çš„é•œåƒ_é²æ»¨é€ŠâŠ™çš„åšå®¢-CSDNåšå®¢_docker åˆ é™¤é•œåƒç¼“å­˜](https://blog.csdn.net/weixin_42324489/article/details/124589161 "docker æ¸…ç†ç¼“å­˜ã€æ—¥å¿—ã€æ— ç”¨çš„é•œåƒ_é²æ»¨é€ŠâŠ™çš„åšå®¢-CSDNåšå®¢_docker åˆ é™¤é•œåƒç¼“å­˜")


------------
## # æ–¹æ³•äºŒ
### å¼•è¨€
- ç”¨äº†Dockerï¼Œå¥½å¤„æŒºå¤šçš„ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªä¸å¤§ä¸å°çš„é—®é¢˜ï¼Œå®ƒä¼šä¸€ä¸å°å¿ƒå ç”¨å¤ªå¤šç£ç›˜ï¼Œè¿™å°±æ„å‘³ç€æˆ‘ä»¬å¿…é¡»åŠæ—¶æ¸…ç†ã€‚

- æ¸…ç†dockerçš„æ—¶å€™éœ€è¦æ˜ç¡®æˆ‘ä»¬çš„ç›®çš„ï¼Œå°±æ˜¯æˆ‘ä»¬éœ€è¦æ¸…ç†çš„æ˜¯ä»€ä¹ˆã€‚

#### docker system df
    # æŸ¥çœ‹dockerå„ç±»å‹æ–‡ä»¶å ç”¨æƒ…å†µ
    docker system df
 
> è¯¥å‘½ä»¤åˆ—å‡ºäº† docker ä½¿ç”¨ç£ç›˜çš„ 4 ç§ç±»å‹ï¼š
> `Images`: æ‰€æœ‰é•œåƒå ç”¨çš„ç©ºé—´ï¼ŒåŒ…æ‹¬æ‹‰å–çš„é•œåƒã€æœ¬åœ°æ„å»ºçš„é•œåƒ
> `Containers`: è¿è¡Œä¸­çš„å®¹å™¨æ‰€å ç”¨çš„ç©ºé—´ï¼ˆæ²¡è¿è¡Œå°±ä¸å ç©ºé—´ï¼‰ï¼Œå…¶å®å°±æ˜¯æ¯ä¸ªå®¹å™¨è¯»å†™å±‚çš„ç©ºé—´
> `Local Volumes`: æœ¬åœ°æ•°æ®å·çš„ç©ºé—´
> `Build Cache`: é•œåƒæ„å»ºè¿‡ç¨‹ä¸­ï¼Œäº§ç”Ÿçš„ç¼“å­˜æ•°æ®
> `# RECLAIMABL` è¿™ä¸ªå­—æ®µæ˜ç¡®äº†è¯¥ç±»å‹ä¸­å¯ä»¥æ¸…ç†çš„ç©ºé—´


æˆ‘ä»¬ä½¿ç”¨ docker é•œåƒåˆ›å»ºå®¹å™¨æ—¶ï¼Œdockerä¼šåˆ›å»ºä¸€äº›ç›®å½•ï¼Œå¦‚ï¼š

- /var/lib/docker/containers/<å®¹å™¨ID> ç›®å½•ï¼Œå¦‚æœå®¹å™¨ä½¿ç”¨äº†é»˜è®¤çš„æ—¥å¿—æ¨¡å¼ï¼Œé‚£ä¹ˆè¯¥å®¹å™¨çš„æ—¥å¿—ä¼šä»¥ JSON å½¢å¼ä¿å­˜åœ¨æ­¤ç›®å½•ä¸‹ã€‚
- /var/lib/docker/overlay2 ç›®å½•ï¼Œè¯¥ç›®å½•åŒ…å«å®¹å™¨çš„è¯»å†™å±‚ï¼Œå¦‚æœå®¹å™¨ä½¿ç”¨è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿä¿å­˜äº†æ•°æ®ï¼Œé‚£ä¹ˆè¿™äº›æ•°æ®å°±ä¼šå†™åˆ°æ­¤ç›®å½•ä¸‹ã€‚


### 1ã€æ¸…ç†å®¹å™¨æ—¥å¿—

------------



> Containers åŒ…å«çš„æˆ‘ä»¬å®¹å™¨è‡ªèº«çš„å®¹é‡ã€äº§ç”Ÿçš„æ•°æ®å®¹é‡ã€äº§ç”Ÿçš„æ—¥å¿—å®¹é‡

     # æŸ¥çœ‹æ‰€æœ‰å®¹å™¨ä¸‹æ—¥å¿—çš„å¤§å°
     find /var/lib/docker/containers/ -name *-json.log |xargs du -sh

	 # å†™ä¸ªç©ºæ–‡ä»¶åˆ°å®¹å™¨æ—¥å¿—ä¸­
    cat /dev/null > /var/lib/docker/containers/3c1452f817fad2296d1c105112faed89d01feaa4ee094e8622c959e072012f7a/3c1452f817fad2296d1c105112faed89d01feaa4ee094e8622c959e072012f7a-json.log
 
    # å°†æŸä¸ªæ—¥å¿—æ–‡ä»¶æ¸…é›¶ğŸ†‘
    truncate -s 0 /var/lib/docker/containers/3c1452f817fad2296d1c105112faed89d01feaa4ee094e8622c959e072012f7a/3c1452f817fad2296d1c105112faed89d01feaa4ee094e8622c959e072012f7a-json.log

ä¸¾ä¾‹ï¼šè¿™é‡Œå¯ä»¥çœ‹å‡ºæˆ‘çš„å…¶ä¸­ä¸€ä¸ªå®¹å™¨çš„æ—¥å¿—å·²ç»åˆ°14G

    [root@i
    find /var/lib/docker/containers/-name *-json.log Ixargs du -sh
    16M
    /var/Lib/docker/containers/4e37a781ceaa29505fd7f2d0d9f2e993356620bbfOe5eab68a459ac359150fe2/4e37a781ceaa29505fd7f2d0d9f2e993356620
    bbf0e5eab68a459ac359150fe2-json.log
    14G
    /var/lib/docker/containers/3c1452f817fad2296d1c105112faed89d01feaa4ee094e8622c959e072012f7a/3c1452f817fad2296d1c105112faed89d01fea
    a4ee094e8622c959e072012f7a-json.1og
    9.6M

#### è®¾ç½®å®¹å™¨æ—¥å¿—çš„æœ€å¤§å®¹é‡
- ä¸‹é¢æ˜¯nginxçš„è®¾ç½®çš„ä¾‹å­

`nginx:
  image: nginx:1.12.1;
  restart: always;
  logging:
    driver: "json-file";
  options:
    max-size: "5g"`

### 2ã€æ¸…ç†æ— ç”¨çš„imageã€volumeã€container
------------
- å¦‚æœå‘ç°æœ‰äº›å®¹å™¨ã€æ•°æ®å·æ˜¯æ²¡æœ‰è¢«ä½¿ç”¨çš„ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤æ¸…ç† Docker å ç”¨çš„ç©ºé—´

        # æ¸…ç†æ‰€æœ‰æ²¡ç”¨çš„imageã€volumeã€container
        # ä½†æ˜¯è¿™ä¸ªå‘¢ä¼šæŠŠä½ æš‚æ—¶åœæ­¢çš„å®¹å™¨ã€é•œåƒä¹Ÿåˆ é™¤æ‰
        # å½“å‰å‘½ä»¤å¯ä»¥ç”¨äºæ¸…ç†ç£ç›˜ï¼Œåˆ é™¤å…³é—­çš„å®¹å™¨ã€æ— ç”¨çš„æ•°æ®å·å’Œç½‘ç»œï¼Œä»¥åŠdanglingé•œåƒï¼ˆå³æ— tagçš„é•œåƒï¼‰
        docker system prune
        # å½“å‰å‘½ä»¤æ¸…ç†å¾—æ›´åŠ å½»åº•ï¼Œå¯ä»¥å°†æ²¡æœ‰å®¹å™¨ä½¿ç”¨Dockeré•œåƒéƒ½åˆ æ‰
        docker system prune -a

å½“ç„¶ä¹Ÿæ˜¯æœ‰å…¶ä»–é€‰æ‹©çš„ï¼š
    
    #åˆ é™¤æ‰€æœ‰å…³é—­çš„å®¹å™¨ï¼š
    docker ps -a | grep Exit | cut -d ' ' -f 1 | xargs docker rm

    #åˆ é™¤æ‰€æœ‰danglingé•œåƒï¼ˆå³æ— tagçš„é•œåƒï¼‰ï¼š
    docker rmi $(docker images | grep "^<none>" | awk "{print $3}")

    #åˆ é™¤æ‰€æœ‰danglingæ•°æ®å·ï¼ˆå³æ— ç”¨çš„Volumeï¼‰ï¼š
    docker volume rm $(docker volume ls -qf dangling=true)

    #æ•°æ®å·å®¹å™¨åˆ é™¤
    docker rm -v  å·å


### 3.1æ§åˆ¶å®¹å™¨æ—¥å¿—å¤§å°
- ä»¥ä¸Šåªæ˜¯ä¸´æ—¶è§£å†³çš„æ–¹å¼ï¼Œæœ€å¥½æ˜¯åˆ›å»ºå®¹å™¨æ—¶å°±æ§åˆ¶æ—¥å¿—çš„å¤§å°.

### 3.2 è¿è¡Œæ—¶æ§åˆ¶
- å¯åŠ¨å®¹å™¨æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å‚æ•°æ¥æ§åˆ¶æ—¥å¿—çš„æ–‡ä»¶ä¸ªæ•°å’Œå•ä¸ªæ–‡ä»¶çš„å¤§å°


    # max-size æœ€å¤§æ•°å€¼
    # max-file æœ€å¤§æ—¥å¿—æ•°
    $ docker run -it --log-opt max-size=10m --log-opt max-file=3 redis
ä¸€ä¸¤ä¸ªå®¹å™¨è¿˜å¥½ï¼Œä½†æ˜¯å¦‚æœæœ‰å¾ˆå¤šå®¹å™¨éœ€è¦ç®¡ç†ï¼Œè¿™æ ·å°±å¾ˆä¸æ–¹ä¾¿äº†ï¼Œæœ€å¥½è¿˜æ˜¯å¯ä»¥ç»Ÿä¸€ç®¡ç†ã€‚

### 3.5 å…¨å±€é…ç½®

åˆ›å»ºæˆ–ä¿®æ”¹æ–‡ä»¶` /etc/docker/daemon.json`ï¼Œå¹¶å¢åŠ ä»¥ä¸‹é…ç½®

    {
    "log-driver":"json-file",
    "log-opts":{
    "max-size" :"50m","max-file":"1"
    }
    }
éšåé‡å¯ Docker æœåŠ¡

    $ sudo systemctl daemon-reload
    $ sudo systemctl restart docker
ä¸è¿‡å·²å­˜åœ¨çš„å®¹å™¨ä¸ä¼šç”Ÿæ•ˆï¼Œéœ€è¦é‡å»ºæ‰å¯ä»¥ï¼

---------------------------------------------------------------------------

## å‚è€ƒå‘½ä»¤ï¼š

    # æŸ¥çœ‹ç£ç›˜ä½¿ç”¨æƒ…å†µ
	df -h
    # æŸ¥çœ‹inodeä½¿ç”¨æƒ…å†µ
	df -i

	# æŸ¥çœ‹å½“å‰ç›®å½•ä¸‹å„ä¸ªæ–‡ä»¶åŠç›®å½•å ç”¨ç©ºé—´å¤§å°
    du -sh
> df -hå’Œdu -shæ˜¾ç¤ºçš„ç£ç›˜å¤§å°ä¸ä¸€è‡´åŸå› åŠè§£å†³åŠæ³•
df -hTæ˜¾ç¤º132Gç©ºé—´å…¨éƒ¨å ç”¨ï¼Œdu -shæ˜¾ç¤ºåªå ç”¨30G
